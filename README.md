# SPA-приложение "Комментарии"

## Описание

Многоуровневое SPA-приложение для публикации и обсуждения комментариев с поддержкой вложений, предпросмотра, сортировки, пагинации, real-time обновления (WebSocket) и защитой от XSS.  
Бэкенд — Django + Django Channels + PostgreSQL, фронтенд — Vue 3, всё упаковано в Docker.

---

## Функционал

- Оставлять комментарии с вложениями (картинка или TXT-файл)
- Ответы на комментарии (каскадная вложенность)
- Валидация всех полей на клиенте и сервере
- CAPTCHA для защиты от спама
- Разрешены только теги: `<a>`, `<code>`, `<i>`, `<strong>`
- Проверка валидности и парности тегов (XHTML)
- Предпросмотр сообщения с панелью тегов ([i], [strong], [code], [a])
- Сортировка по User Name, дате, email (LIFO по умолчанию)
- Пагинация по 25 комментариев
- Защита от XSS и SQL-инъекций
- Загрузка изображений (JPG, PNG, GIF) с автоматическим ресайзом до 320x240
- Загрузка TXT-файлов до 100кб
- Просмотр изображений с lightbox-эффектом
- Реальное время: новые комментарии появляются у всех пользователей без перезагрузки (WebSocket)
- Авторизация через JWT, автоматическое обновление токена (refresh)
- Docker-сборка, готовая к деплою

---

## Быстрый старт и деплой на AWS

### 1. Подготовка сервера (EC2)

- Создайте EC2-инстанс (Ubuntu 22.04).
- Откройте порты 80, 443, 8000, 5173 (если нужно).
- Установите Docker и Docker Compose:
  ```sh
  sudo apt update
  sudo apt install -y docker.io docker-compose
  sudo usermod -aG docker $USER
  ```

### 2. Клонируйте репозиторий

```sh
git clone <URL-ВАШЕГО-РЕПОЗИТОРИЯ>
cd <папка-проекта>
```

### 3. Настройте переменные окружения

- Создайте файл `.env` (или отредактируйте `docker-compose.yml`), укажите параметры БД, секреты и т.д.

### 4. Запустите проект в Docker

```sh
docker-compose up -d --build
```

### 5. Автоматизация миграций и сборка статики

Выполните миграции и соберите статику одной командой:

```sh
docker-compose exec web sh -c "python manage.py makemigrations && python manage.py migrate && python manage.py collectstatic --noinput"
```

### 6. (Опционально) Создайте суперпользователя

```sh
docker-compose exec web python manage.py createsuperuser
```

---

## Автоматический запуск фронтенда и бэкенда

Файл `docker-compose.yml` настроен так, что **фронтенд и бэкенд запускаются одной командой**.  
Для этого в корне проекта должны быть две папки:  
- `backend/` — Django-проект  
- `frontend/` — Vue 3 SPA

В папке `frontend` должен быть файл `Dockerfile` такого вида:

```dockerfile
# filepath: frontend/Dockerfile
FROM node:20

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

EXPOSE 5173

CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
```

**Запуск всего проекта:**
```sh
docker-compose up -d --build
```

---

## Структура проекта

- `backend/` — Django-проект (API, Channels, PostgreSQL, Redis)
- `frontend/` — Vue 3 SPA (Vite)
- `docker-compose.yml` — запуск всех сервисов
- `requirements.txt` — зависимости Python

---

### Добавление комментария

1. Заполните форму (User Name, Email, CAPTCHA, Text)
2. Прикрепите файл (опционально)
3. Используйте панель тегов для форматирования текста
4. Предпросмотрите сообщение перед отправкой

### Ответ на комментарий

- Нажмите "Відповісти" под нужным комментарием

### Сортировка и пагинация

- Кликните по заголовку таблицы для сортировки
- Используйте кнопки "Назад/Вперед" для перехода между страницами

### Просмотр вложений

- Клик по картинке — откроет lightbox
- Клик по TXT — скачает файл

---

## Безопасность

- Все поля валидируются на клиенте и сервере
- Только разрешённые HTML-теги, XSS невозможен
- SQL-инъекции невозможны (используется Django ORM)
- JWT-токены автоматически обновляются через refresh token

---

## Схема БД

В проекте используются три основные сущности:

- **Comment**
  - `id` — уникальный идентификатор комментария
  - `parent` — внешний ключ на другой комментарий (для вложенных ответов)
  - `user` — внешний ключ на пользователя (автор комментария)
  - `created_at` — дата и время создания
  - `email` — email пользователя
  - `homepage` — домашняя страница пользователя (URL)
  - `text` — текст комментария
  - `username` — имя пользователя

- **Attachment**
  - `id` — уникальный идентификатор вложения
  - `comment` — внешний ключ на комментарий, к которому относится вложение
  - `file` — путь к файлу (изображение или текстовый файл)
  - `uploaded_at` — дата и время загрузки файла

- **User**
  - стандартная модель пользователя Django (auth_user)

**Связи:**
- Один комментарий может быть ответом на другой комментарий (`parent`)
- Один комментарий может иметь несколько вложений (`Attachment`)
- Один пользователь может иметь несколько комментариев (`user`)

> Вся структура и связи отражены на ER-диаграмме выше (`comments.png`).  
> Схема полностью соответствует models.py и миграциям Django.

---

## Видео-демонстрация

Видео с демонстрацией работы приложения:  
https://drive.google.com/file/d/1h7h3ZyuVeSJY7k_26GtHo0rs72FLZsTL/view?usp=sharing

---

## Разработчик

- Гончаренко Максим
- @M128ax
- [\[Ссылка на GitHub\]](https://github.com/MaximHoncharenko/Dzen-TT)

---

## Примечания

- Для production-режима настройте переменные окружения и секретные ключи.
- Для деплоя на сервере используйте docker-compose и инструкции из README.

---

Доступ к развернутому приложению
Приложение: http://54.196.231.54
API Endpoints:

API: http://54.196.231.54/api/comments/  
Admin: http://54.196.231.54/admin/
Health: http://54.196.231.54/health
Swagger: http://54.196.231.54/swagger/
